## Test 06: Memory Leak Check [1 pts]

```

if ! ( which valgrind &> /dev/null ); then
    # "valgrind is not installed. Please install (as root) with:"
    # "pacman -Sy valgrind"
    test_end 1
fi

leak_output=$(timeout 10 valgrind \
    --trace-children=yes \
    --child-silent-after-fork=no \
    --leak-check=full \
    --track-fds=yes \
    --show-leak-kinds=all \
    --track-origins=yes \
    ./miner 8 10 'Memory Leak Check' 2>&1)

echo "${leak_output}"
==993104== Memcheck, a memory error detector
==993104== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.
==993104== Using Valgrind-3.18.1 and LibVEX; rerun with -h for copyright info
==993104== Command: ./miner 8 10 Memory\ Leak\ Check
==993104== 
miner.c:298:main(): Starting prod loop 0
miner.c:302:main(): buffer: 0  global_nonce: 0
miner.c:316:main(): Didnt get stuck
miner.c:326:main(): buffer: 1
miner.c:298:main(): Starting prod loop 100000
miner.c:302:main(): buffer: 1  global_nonce: 0
miner.c:82:consumer_thread(): start: 600001 buffer: 1 rank:6
miner.c:85:consumer_thread(): iteration: 0
miner.c:110:consumer_thread(): set new nonce ranges 1 100001
miner.c:82:consumer_thread(): start: 1 buffer: 0 rank:0
miner.c:85:consumer_thread(): iteration: 0
miner.c:127:consumer_thread(): Got till here after setting end
miner.c:127:consumer_thread(): Got till here after setting end
miner.c:139:consumer_thread(): valid nonce
miner.c:82:consumer_thread(): start: 300001 buffer: 0 rank:3
miner.c:85:consumer_thread(): iteration: 0
miner.c:82:consumer_thread(): start: 400001 buffer: 0 rank:4
miner.c:85:consumer_thread(): iteration: 0
miner.c:139:consumer_thread(): valid nonce
miner.c:82:consumer_thread(): start: 700001 buffer: 0 rank:7
miner.c:85:consumer_thread(): iteration: 0
miner.c:82:consumer_thread(): start: 100001 buffer: 0 rank:1
miner.c:85:consumer_thread(): iteration: 0
miner.c:82:consumer_thread(): start: 500001 buffer: 0 rank:5
miner.c:85:consumer_thread(): iteration: 0
miner.c:82:consumer_thread(): start: 200001 buffer: 0 rank:2
miner.c:85:consumer_thread(): iteration: 0
miner.c:127:consumer_thread(): Got till here after setting end
miner.c:139:consumer_thread(): valid nonce
miner.c:127:consumer_thread(): Got till here after setting end
miner.c:139:consumer_thread(): valid nonce
miner.c:311:main(): Post wait 0
miner.c:316:main(): Didnt get stuck
miner.c:319:main(): breaking prod loop
miner.c:335:main(): Trying to join 0
miner.c:335:main(): Trying to join 1
miner.c:127:consumer_thread(): Got till here after setting end
miner.c:139:consumer_thread(): valid nonce
miner.c:127:consumer_thread(): Got till here after setting end
miner.c:139:consumer_thread(): valid nonce
miner.c:127:consumer_thread(): Got till here after setting end
miner.c:139:consumer_thread(): valid nonce
miner.c:335:main(): Trying to join 2
miner.c:127:consumer_thread(): Got till here after setting end
miner.c:139:consumer_thread(): valid nonce
miner.c:335:main(): Trying to join 3
miner.c:335:main(): Trying to join 4
miner.c:335:main(): Trying to join 5
miner.c:335:main(): Trying to join 6
miner.c:335:main(): Trying to join 7
==993104== Use of uninitialised value of size 8
==993104==    at 0x499E82A: _itoa_word (in /usr/lib/libc.so.6)
==993104==    by 0x49B7F5B: __vfprintf_internal (in /usr/lib/libc.so.6)
==993104==    by 0x49C2F75: __vsprintf_internal (in /usr/lib/libc.so.6)
==993104==    by 0x49A49F7: sprintf (in /usr/lib/libc.so.6)
==993104==    by 0x10AFCB: sha1tostring (sha1.c:258)
==993104==    by 0x10A427: main (miner.c:351)
==993104==  Uninitialised value was created by a stack allocation
==993104==    at 0x109A3F: main (miner.c:212)
==993104== 
==993104== Conditional jump or move depends on uninitialised value(s)
==993104==    at 0x499E83C: _itoa_word (in /usr/lib/libc.so.6)
==993104==    by 0x49B7F5B: __vfprintf_internal (in /usr/lib/libc.so.6)
==993104==    by 0x49C2F75: __vsprintf_internal (in /usr/lib/libc.so.6)
==993104==    by 0x49A49F7: sprintf (in /usr/lib/libc.so.6)
==993104==    by 0x10AFCB: sha1tostring (sha1.c:258)
==993104==    by 0x10A427: main (miner.c:351)
==993104==  Uninitialised value was created by a stack allocation
==993104==    at 0x109A3F: main (miner.c:212)
==993104== 
==993104== Conditional jump or move depends on uninitialised value(s)
==993104==    at 0x49B89FB: __vfprintf_internal (in /usr/lib/libc.so.6)
==993104==    by 0x49C2F75: __vsprintf_internal (in /usr/lib/libc.so.6)
==993104==    by 0x49A49F7: sprintf (in /usr/lib/libc.so.6)
==993104==    by 0x10AFCB: sha1tostring (sha1.c:258)
==993104==    by 0x10A427: main (miner.c:351)
==993104==  Uninitialised value was created by a stack allocation
==993104==    at 0x109A3F: main (miner.c:212)
==993104== 
==993104== Conditional jump or move depends on uninitialised value(s)
==993104==    at 0x49B80B7: __vfprintf_internal (in /usr/lib/libc.so.6)
==993104==    by 0x49C2F75: __vsprintf_internal (in /usr/lib/libc.so.6)
==993104==    by 0x49A49F7: sprintf (in /usr/lib/libc.so.6)
==993104==    by 0x10AFCB: sha1tostring (sha1.c:258)
==993104==    by 0x10A427: main (miner.c:351)
==993104==  Uninitialised value was created by a stack allocation
==993104==    at 0x109A3F: main (miner.c:212)
==993104== 
Number of threads: 8
We want this difficulty: 10
  Difficulty Mask: 00000000001111111111111111111111
       Block data: [Memory Leak Check]

----------- Starting up miner threads!  -----------

Solution found by thread: 5
Nonce: 187
Hash: 000000000000000040EE0104000000000D000000
1503 hashes in 0.71s (2117.61 hashes/sec)
==993104== 
==993104== FILE DESCRIPTORS: 8 open (3 std) at exit.
==993104== Open file descriptor 99: /home/avkunatharaju/.vscode-server/bin/da15b6fd3ef856477bf6f4fb29ba1b7af717770d/vscode-remote-lock.avkunatharaju.da15b6fd3ef856477bf6f4fb29ba1b7af717770d (deleted)
==993104==    <inherited from parent>
==993104== 
==993104== Open file descriptor 22: /dev/ptmx
==993104==    <inherited from parent>
==993104== 
==993104== Open file descriptor 21: /dev/ptmx
==993104==    <inherited from parent>
==993104== 
==993104== Open file descriptor 20: /dev/ptmx
==993104==    <inherited from parent>
==993104== 
==993104== Open file descriptor 19: /dev/ptmx
==993104==    <inherited from parent>
==993104== 
==993104== 
==993104== HEAP SUMMARY:
==993104==     in use at exit: 0 bytes in 0 blocks
==993104==   total heap usage: 1,520 allocs, 1,520 frees, 63,706 bytes allocated
==993104== 
==993104== All heap blocks were freed -- no leaks are possible
==993104== 
==993104== For lists of detected and suppressed errors, rerun with: -s
==993104== ERROR SUMMARY: 84 errors from 4 contexts (suppressed: 0 from 0)

# Check for open FDs
awk "${fd_check}" <<< "${leak_output}" \
    | grep -i '==[0-9]*==.*file descriptor' && test_end 1

# Make sure there were no leaks possible
grep -i '==[0-9]*==.*no leaks are possible' \
    <<< "${leak_output}" || test_end 1
==993104== All heap blocks were freed -- no leaks are possible

# If none of the conditions were triggered above, the test passes.
test_end 0
```

